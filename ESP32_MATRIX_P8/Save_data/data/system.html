<!DOCTYPE html>
<html lang="fr" id="body-guard">

<head>
    <title>FSBrowserNG System Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="./FSBrowserNG.js"></script>
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css">
</head>

<body >
<div class="card mb-4 d-flex justify-content-center" style="height: 900px; font-size: small">
    <div class="card-body">

        <div class="row mt-5 mb-2">
            <div class="col-sm-1"></div>
            <div class="col-sm-10">
                <h4 class="sub-title"> Editeur FS
                    <hr class="mb-2">
                </h4>
                <div class="d-flex justify-content-end mb-lg-2" >
                    <a class="btn btn-primary btn-block fa-lg gradient-custom-2 border border-color-none" href="/edit/index.htm">Editer</a>
                </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-sm-1"></div>
            <div class="col-sm-10">
                <h4 class="sub-title"> Redémarrage
                    <hr class="mb-2">
                </h4>
                <div class="d-flex justify-content-end mb-lg-2" >
                    <a class="btn btn-primary btn-block fa-lg gradient-custom-2 border border-color-none" href="javascript:restartESP()">Redémarrer</a>
                </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-sm-1"></div>
            <div class="col-sm-10">
                <h4 class="sub-title"> Mise à jour OTA
                    <hr class="mb-2">
                </h4>
                <div class="d-flex justify-content-end mb-lg-2" >
                    <a class="btn btn-primary btn-block fa-lg gradient-custom-2 border border-color-none" onclick="update()">Mise à jour</a>
                </div>
            </div>
        </div>
        
        <div class="row mb-2 mt-3">
            <div class="col-sm-1"></div>
            <div class="col-sm-10">
                <h4 class="sub-title d-flex justify-content-between" > 
                    <div>
                        Luminosité: <span id="lightingValue" style="color: #0091ff;"></span>
                    </div>
                    <div>
                        <label for="auto">Auto</label>
                        <input type="checkbox" class="form-check-input" id="auto" class="my-auto mx-auto" onclick="disable()" style="border: solid black;">
                    </div>
                </h4>
                <hr class="mb-2">
                <div class="d-flex justify-content-between mb-lg-2" >
                    <input class="my-auto mx-auto" type="range" id="lighting" min="1" max="8" style="border: solid black; width: 70%;">
                    <button class="btn btn-primary btn-block fa-lg gradient-custom-2 border border-color-none" onclick="applyLighting()">Appliquer</button>
                </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-sm-1"></div>
            <div class="col-sm-10">
                <h4 class="sub-title">
                    <hr class="mb-2">
                </h4>
                <div class="d-flex justify-content-between mb-lg-2" >
                </div>
            </div>
        </div>
        
        <form id="wwwAuthForm" action="" method="get">
            <div class="d-flex justify-content-center mt-2">
                <div class="col-sm-10">
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-2 d-flex justify-content-end">
                            <label for="wwwuser" class="mb-0">Use User: </label>
                        </div>
                        <div class="col-sm-3">
                            <input style="border: solid black;" type="text" name="wwwuser" id="wwwuser" class="form-control form-control-sm" >
                        </div>
                    </div>
                    <hr>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-2 d-flex justify-content-end">
                            <label for="wwwpass" class="mb-0">Password: </label>
                        </div>
                        <div class="col-sm-3">
                            <input style="border: solid black;" type="password" id="wwwpass" name="wwwpass" class="form-control form-control-sm" >
                        </div>
                    </div>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-6">
                            <p class="ms-1" id="submitResult" style="color: red; font-size: small; "></p>
                        </div>
                    </div>
                    <hr>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-6">
                            <p class="mb-0">Notice password is used for HTTP Auth, AP Mode and OTA</p>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-end mb-lg-2" >
                        <button id="updateButton" type="button" class="btn btn-primary btn-block fa-lg gradient-custom-2 border border-color-none" onclick='submitFrm(document.forms["wwwAuthForm"])'>Sauvegarder</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script src="./admin.js"></script>

<script>

    window.onload = function() {
        document.getElementById("updateButton").disabled = true;
        read();
        syncLoader.loadFiles(["style.css", "microajax.js"]).then(() => {
            GetState();
        });
        enableAuthFields(document.getElementById("wwwauth"));
        display();
        ranger();
    }

    function display() {
        const input = document.getElementById('wwwpass');
        const button = document.getElementById('updateButton');
        button.disabled = document.getElementById("wwwpass").value === '';
        
        input.addEventListener('input', function() {
            button.disabled = input.value.trim() === '';
        });
    }

    function update() {
        document.getElementById("body-guard").innerHTML = '<iframe src="update.html" style="width: 100%; height: 600px; border-radius: 2%;"></iframe>';
    }

    function enableAuthFields(cb) {
        //document.getElementById("wwwuser").disabled = !cb.checked;
        //document.getElementById("wwwpass").disabled = !cb.checked;
    }

    function submitFrm(frm) {
        if ((document.getElementById("wwwuser").value !== "") && (document.getElementById("wwwpass").value !== "")) {
            document.getElementById("submitResult").innerHTML = "Auth updated";
            console.log("User: " + document.getElementById("wwwuser").value);
            console.log("Pass: " + document.getElementById("wwwpass").value);
            frm.submit();
        } else {
            document.getElementById("submitResult").innerHTML = "User and password must be filled";
        }
    }

    function restartESP() {
        setValues("/admin/restart");
    }

    function applyLighting() {

        const lighting = document.getElementById('lighting');
        const auto = document.getElementById('auto');

        let formData = new FormData();
            
        if(auto.checked){
            formData.append("auto", auto.checked);
        } else {
            formData.append("lighting", lighting.value);
        }
        console.log(formData);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/admin/lighting", true);
        xhr.send(formData);
        
	    setTimeout(() => {
            alert("Luminosité enregistrée avec succès !");
	    }, 1.5*1000);
    }

    function ranger() {
        const rangeInput = document.getElementById('lighting');
        const rangeValue = document.getElementById('lightingValue');

        rangeInput.addEventListener('input', function() {
            rangeValue.textContent = rangeInput.value;
        });
    }

    function disable() {
        
        let lighting = document.getElementById('lighting');
        let auto = document.getElementById('auto');

        console.log("disabled: ", auto.checked);

        if (auto.checked) {
            lighting.disabled = true;

        } else {
            lighting.disabled = false;
        }

    }

    function read() {

        fetch('../jsonFiles/secret.json')
            .then(response => response.json())
            .then(data => {
                // use the 'data' variable which contains the parsed JSON data
                document.getElementById('wwwuser').value = data.user;
                // document.getElementById('wwwpass').value = data.pass;

            })
            .catch(error => {
                // handle any errors that occur during the fetch request
                console.error(error);
            });
        fetch('/admin/lighting')
            .then(response => response.text())
            .then(data => {
            	let fields = data.split('|');
            	console.info(fields);
                document.getElementById('lighting').value = fields[1];
                document.getElementById('lightingValue').textContent = fields[1];
                document.getElementById('auto').checked = fields[3] === '1';

            })
            .catch(error => {
                // handle any errors that occur during the fetch request
                console.error(error);
            });

    }

</script>

</body>

</html>
